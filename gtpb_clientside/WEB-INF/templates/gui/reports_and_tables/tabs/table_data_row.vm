##
##  Copyright 2011 GT webMarque Ltd
## 
##  This file is part of agileBase.
##
##  agileBase is free software: you can redistribute it and/or modify
##  it under the terms of the GNU General Public License as published by
##  the Free Software Foundation, either version 3 of the License, or
##  (at your option) any later version.
##  agileBase is distributed in the hope that it will be useful,
##  but WITHOUT ANY WARRANTY; without even the implied warranty of
##  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License
##  along with agileBase.  If not, see <http://www.gnu.org/licenses/>.
##
## Used by view.vm and edit.vm
## $tableDataRow and $field must be defined by them
#set($loggedInUser = $view.getLoggedInUser())
#set($contractedSections = $loggedInUser.getContractedSections())
#set($internalFieldName = $field.getInternalFieldName())
#if (! $field.getTableContainingField().getPrimaryKey().equals($field)) ## remove to show primary key field
  #if($address)
	#if($address.size() > 0)
	  #if($address.firstKey().equals($field)) #set($partOfAddress = true) #end
      #if($partOfAddress && $address.firstKey().equals($field))
	    #set($firstLineOfAddress = true)
	  #else
	    #set($firstLineOfAddress = false)
	  #end
	#end
  #end
  #if($partOfAddress)
	#if($firstLineOfAddress)
		#set($rowCount = $rowCount + 1)
		<tr #if($rowCount%2!=0) class="rowb" #else class="rowa" #end>
			#if(!$edit_nav)<td class=leading>&nbsp;</td>#end
      <td class="capitalised">Address</td>
			<td><table border="0"><tr><td width="100px" style="border-right:0"><div id="map" style="width:100px;height:100px"></div>
			</td><td style="border-right:0">
    #end
	#parse('gui/resources/input/input.vm')<br>
	#if($address.lastKey().equals($field))
		<script langauge="JavaScript">
		  loadMap("$tableDataRow.get($field).toString()");
		</script>
		    #set($partOfAddress = false)
			</td></tr></table>
			</td>
			#if(!$edit_nav)<td class=trailing>&nbsp;</td>#end
		</tr>
	#end
  #else
	#set($fieldCategory = $field.getFieldCategory())
	#set($referencedData = "")
	#if($fieldCategory == "REFERENCED_REPORT_DATA")
	  ## Capture the output of the parsing into a variable. We want to know whether a value
	  ## exists or not for this field so we can choose whether to display the row
	  #set($referencedData = "#parse('gui/resources/input/referenced_report_data.vm')")
	#end
	#if(($fieldCategory != "REFERENCED_REPORT_DATA") || $referencedData.contains("span"))
	  #if(($fieldCategory != "FILE") || (!$ab_calendar_display)) ## Don't show file fields in calendar editor for now
    	#set($rowCount = $rowCount + 1)
      #if($fieldCategory == 'SEPARATOR')
        #set($contracted = false)
        #if((!$edit_nav) && $contractedSections.contains($internalFieldName))
          #set($contracted = true)
        #end
      #end
    	<tr title="$field.getFieldDescription()" #if($fieldCategory =='SEPARATOR') #set($rowCount=0) class="separator #if($contracted) contracted #end" internalfieldname="$internalFieldName" #elseif($rowCount%2!=0) class="rowb" #else class="rowa" #end #if(($fieldCategory !='SEPARATOR') && $contracted) style="display:none;" #end>
    		#if(!$edit_nav)<td class=leading>&nbsp;</td>#end
            <!-- class printoutfieldnamecolumn is only defined when printing - see detail.vm -->
            <td class="capitalised printoutfieldnamecolumn" #if($fieldCategory =='SEPARATOR') colspan="2" #end>
            <span class="saved" id="saved_$internalFieldName"><image src="resources/icons/tick.png" style="vertical-align: top" /> </span>
            #if($field.getClass().getSimpleName().equals("RelationFieldDefn"))
              <span class="fieldname">$field.getSimplifiedFieldName()</span>
            #else
              <span class="fieldname">$field</span>
            #end
            #if(!$viewOnly && $fieldCategory !='SEPARATOR')<br>#end
              ##<i><span class="greytext">$field.getFieldDescription()</span></i>
            </td>
            #if($fieldCategory !='SEPARATOR')<td>#parse('gui/resources/input/input.vm')</td>#end
            #if(!$edit_nav)<td class=trailing>&nbsp;</td>#end
        </tr>
	  #end
	#end
  #end ## end if not partOfAddress
#end ## remove to show primary key field
