#if(!$report)
  #set($report = $sessionData.getReport())
#end
#set($table = $report.getParentTable())
#if($report.equals($table.getDefaultReport()))
  ## Don't start with a 'raw table' report
  #set($tableReports = $table.getReports())
  #foreach($tableReport in $tableReports)
    #if((!$tableReport.equals($table.getDefaultReport())) && ($view.loggedInUserAllowedToViewReport($tableReport)) && (!$tableReport.getReportName().contains("dbvcalc")) && (!$tableReport.getReportName().contains("dbvcrit")))
      #set($report = $tableReport)
      #break
    #end
  #end
#end
#set($internalTableName = $table.getInternalTableName())
#set($reportBaseFields = $report.getReportBaseFields())##
#if(!$reportDataRows)
  #if(!$filters)
    #set($reportDataRows = $view.getGloballyFilteredReportDataRows($report))
  #else
    #set($reportDataRows = $view.getReportDataRows($report, 100, $filters, true))##
  #end
#end
<div class="related block centrebox" href="AppController.servlet?return=gui/edit_nav/edit&set_table=$internalTableName&save_new_record=true&gtpb_override_relation_default_to_null=true">
  <span class="new"><img src="resources/toolbar/new.png"> add new $table.getSimpleName()</span>
</div>
#foreach($row in $reportDataRows)
  #set($dataRowFields = $row.getDataRowFields())
  #set($lastUniqueId = $thisUniqueId)
  #set($thisUniqueId = $row.getRowId())
  #set($emboldened = false)
  #if($thisUniqueId != $lastUniqueId)
  ##onclick is workaround for iOS bug http://blog.alanszlosek.com/post/4369588562/jquerys-live-click-handler-on-mobile-safari
  <div class="related block current" href="AppController.servlet?return=gui/edit_nav/edit&set_table=$internalTableName&set_row_id=$thisUniqueId" onclick=""> 
    #foreach($field in $reportBaseFields)##
      #if(!$field.getTableContainingField().getPrimaryKey().equals($field))
        #set($dataRowField = $dataRowFields.get($field))
        #set($cell = $dataRowField.getDisplayValue())
        #set($colour = $dataRowField.getStandardDevHexColour())
        #set($fieldCategory = $field.getFieldCategory().toString())
        #set($image = false)
        #if($fieldCategory == "FILE")
          #set($fileValue = $viewTools.getFileValueTool($cell))
          #if($fileValue.isImage())
            #set($srcUrl = "/agileBase/uploads/$internalTableName/$field.getInternalFieldName()/$thisUniqueId/$fileValue.40.$fileValue.getExtension()")
            <img src="$srcUrl" style="float:left"/>
            #set($image = true)
          #end
        #end
        #set($style="")
        #set($class="")
        #if($colour && $colour !="") #set($style="background-color:$colour; ") #set($class="colored") #end
        #if($cell && (!$image) && ($cell != ""))
          #set($printoutSetting = $field.getPrintoutSetting())
          #if($fieldCategory == "CHECKBOX")
            #if($cell == "true")
              <span style="$style" class="cell $class">$field</span>
            #end
          #elseif($printoutSetting == "NAME_AND_VALUE")
            <span class="fieldname">$field</span>: <span style="$style" class="cell $class">$cell</span><br>
          #else
            #if(!$emboldened)
              #set($style = "$style font-weight: bold; ")
            #end
            <span style="$style" class="cell $class">$cell</span>,
            #set($emboldened = true)
          #end
        #end
      #end
    #end
  </div>
  #end
#end