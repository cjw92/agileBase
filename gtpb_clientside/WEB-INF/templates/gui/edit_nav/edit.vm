#set($edit_nav = true)
#set($sessionTable = $sessionData.getTable())
#set($fields = $sessionTable.getFields())
#set($referencedTableReports = {})
#foreach($field in $fields)
  #if($field.getFieldCategory() == "REFERENCED_REPORT_DATA")
    #set($referencedReport = $field.getReferencedReport())
    #set($success = $referencedTableReports.put($referencedReport.getParentTable(), $referencedReport))
  #end
#end
#set($referencedTables = $referencedTableReports.keySet())
<div class="breadcrumb_title">edit $sessionTable.getSimpleName()</div>
<div class="presentation"> 
  <div id="presentation-counter"></div> 
  <div class="slides">
    <div class="slide"> 
      <section class="middle"> 
        <div class="this_table">
          #parse("gui/reports_and_tables/tabs/edit.vm")
        </div>
        <div class="dependent_tables">
          ## tableDataRow will have been set in edit.vm above
          #if(!$tableDataRow)
            #set($tableDataRow = $view.getTableDataRow())
          #end
          ## each relation field
          #foreach($field in $fields)
            #if($field.getFieldCategory() == "RELATION")
              #set($relatedTable = $field.getRelatedTable())
              #set($relatedRowIdValue = $tableDataRow.get($field.getRelatedField()))
              #set($snippet = "")
              #set($active = false)
              #set($fieldDisplayValue = "")
              #if(!$relatedRowIdValue.isNull())
                #set($relatedRowId = $relatedRowIdValue.getValueInteger())
                #if($relatedRowId)
                  #set($active = true)
                  #set($relatedDataRow = $view.getTableDataRow($relatedTable, $relatedRowId))
                  #set($fieldDisplayValue = $relatedDataRow.get($field.getDisplayField()))##
                  #foreach($relatedField in $relatedDataRow.keySet())
                    #if(!$relatedField.equals($relatedField.getTableContainingField().getPrimaryKey()))
                    #set($fieldValue = $relatedDataRow.get($relatedField))
                      #if(($fieldValue != "") && ($fieldValue != "false"))
                        #set($snippet = "$snippet$fieldValue, ")
                      #end
                    #end
                  #end
                #end
              #end
              <div class="dependent_table related #if($active) active #end" id="dependent_relation_$sessionTable.getInternalTableName()_$relatedTable.getInternalTableName()" internaltablename="$relatedTable.getInternalTableName()" rowid="$relatedRowId">
                <h1><span class="count"><img src="resources/edit_nav/up.png" alt="up" /></span>$field.getSimplifiedFieldName()#if($fieldDisplayValue != ""): $fieldDisplayValue#end</h1>
                <div class="record_snippets">
                  <div class="snippet">$snippet</div>
                </div>
              </div>
            #end
          #end
          ## dependent child tables
          #set($primaryKey = $sessionTable.getPrimaryKey())
          #set($dependentTables = $view.getDirectlyDependentTables($sessionTable))
          #foreach($dependentTable in $dependentTables)
            ## don't include those which are covered by cross-referenced fields
            #if(!$referencedTables.contains($dependentTable))
              #if($view.loggedInUserAllowedTo("VIEW_TABLE_DATA", $dependentTable))
                #foreach($report in $dependentTable.getReports())
                  #if(($view.loggedInUserAllowedToViewReport($report)) && ($report.getReportBaseFields().contains($primaryKey)) && (!$report.getReportName().contains("dbvcalc")) && (!$report.getReportName().contains("dbvcrit")))
                    <div class="dependent_table" id="dependent_table_$sessionTable.getInternalTableName()_$dependentTable.getInternalTableName()">
                      <h1><span class="count"></span>$dependentTable.getSimpleName()</h1>
                      <div class="record_snippets">
                      </div>
                    </div>
                    #break ## next table
                  #end
                #end
              #end
            #end
          #end
          ## cross-reference fields
          #foreach($field in $fields)
            #if($field.getFieldCategory() == "REFERENCED_REPORT_DATA")
              #set($referencedReport = $field.getReferencedReport())
              #set($referencedTable = $referencedReport.getParentTable())
              <div class="dependent_table cross_reference" id="dependent_table_$sessionTable.getInternalTableName()_$referencedTable.getInternalTableName()">
                <h1><span class="count"></span>$field</h1>
                <div class="record_snippets">
                </div>
              </div>
            #end
          #end
        </div>
      </section> 
    </div>  
  </div> <!-- slides --> 
</div> <!-- presentation --> 